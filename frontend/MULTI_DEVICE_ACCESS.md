# 多设备访问说明

## 当前实现的行为

### ✅ 已解决的问题

1. **客户端隔离**：
   - 每个浏览器/设备会生成一个唯一的客户端ID（存储在localStorage中）
   - 客户端ID会自动包含在thread_id中，确保不同设备的对话记忆隔离

2. **对话记忆隔离**：
   - 智能问答：每个设备的thread_id是独立的，不会互相干扰
   - 问卷生成：即使使用相同的参数，不同设备的thread_id也会不同

3. **前端数据持久化**：
   - 每个设备的localStorage是独立的
   - 表单数据、对话历史等只在当前设备可见

### ⚠️ 需要注意的情况

1. **同一用户使用不同设备**：
   - **对话历史不会同步**：设备A的对话历史不会在设备B显示
   - **thread_id不同**：后端会为每个设备维护独立的对话记忆
   - **表单数据不同步**：设备A填写的表单，设备B看不到

2. **多个用户使用相同参数**：
   - **智能问答**：不同用户使用相同的thread_id前缀会被隔离（因为客户端ID不同）
   - **问卷生成**：相同参数会生成不同的thread_id（包含客户端ID前缀）

3. **清除浏览器数据**：
   - 清除localStorage后，客户端ID会重新生成
   - 之前的对话历史和thread_id会丢失
   - 后端仍保留旧的对话记忆（基于旧的thread_id），但前端无法恢复

## 技术实现

### 客户端ID生成
- 文件：`frontend/lib/client-id.ts`
- 存储：localStorage中的`consult_client_id`
- 格式：UUID v4（如：`550e8400-e29b-41d4-a716-446655440000`）

### thread_id格式
- **智能问答**：`{client_id}:{uuid}` 或直接 `{uuid}`
- **问卷生成**：`{client_id}:{workspace_id}:{company_name}:{projects}`

### 数据存储位置
- **前端**：localStorage（设备本地）
- **后端**：LangGraph MemorySaver（服务器端，基于thread_id）

## 未来改进建议

1. **用户账户系统**：
   - 实现用户登录，使用user_id替代client_id
   - 对话历史可以在不同设备间同步

2. **云端同步**：
   - 将localStorage数据同步到后端
   - 支持跨设备访问对话历史和表单数据

3. **会话管理**：
   - 添加会话过期机制
   - 自动清理过期的对话记忆

## 使用建议

- **单设备使用**：当前实现完全满足需求，数据会持久化
- **多设备使用**：如果需要数据同步，建议实现用户登录功能
- **隐私保护**：客户端ID不会泄露用户身份，只是设备标识

