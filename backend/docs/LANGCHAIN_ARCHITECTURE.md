# LangChain RAG æ¶æ„è¯¦ç»†åˆ†æ

## ğŸ“‹ ç›®å½•
1. [æ•´ä½“æ¶æ„æ¦‚è§ˆ](#æ•´ä½“æ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#æ ¸å¿ƒç»„ä»¶è¯¦è§£)
3. [å·¥ä½œæµç¨‹](#å·¥ä½œæµç¨‹)
4. [å½“å‰å®ç°çš„æŠ€æœ¯ç‰¹ç‚¹](#å½“å‰å®ç°çš„æŠ€æœ¯ç‰¹ç‚¹)
5. [ä¸å…ˆè¿›æ–¹æ¡ˆçš„å¯¹æ¯”](#ä¸å…ˆè¿›æ–¹æ¡ˆçš„å¯¹æ¯”)
6. [æ”¹è¿›æ–¹å‘ä¸å»ºè®®](#æ”¹è¿›æ–¹å‘ä¸å»ºè®®)

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„æ¦‚è§ˆ

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚ (React)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  æ–‡æ¡£ä¸Šä¼     â”‚  â”‚   é—®ç­”å¯¹è¯   â”‚  â”‚  æ–‡æ¡£ç®¡ç†    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â”‚      HTTP API    â”‚                  â”‚
          â”‚   + WebSocket    â”‚                  â”‚
          â”‚                  â”‚                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI åç«¯å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              API Endpoints (app_simple.py)               â”‚   â”‚
â”‚  â”‚  â€¢ æ–‡æ¡£ä¸Šä¼   â€¢ é—®ç­”å¯¹è¯  â€¢ å·¥ä½œåŒºç®¡ç†  â€¢ çŠ¶æ€è¿½è¸ª        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Task Queue (å¼‚æ­¥ä»»åŠ¡ç®¡ç†)                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                 â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LangChainRAG      â”‚  â”‚ XX       â”‚  â”‚ File Index     â”‚
â”‚ Service           â”‚  â”‚ RAG      â”‚  â”‚ Manager        â”‚
â”‚ (ä¸»æœåŠ¡)          â”‚  â”‚ Service  â”‚  â”‚ (JSONç®¡ç†)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                        â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Enhanced   â”‚  â”‚ Smart Cache  â”‚  â”‚ FAISS Vector      â”‚
â”‚ Document   â”‚  â”‚ Manager      â”‚  â”‚ Store             â”‚
â”‚ Processor  â”‚  â”‚              â”‚  â”‚                   â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–‡æ¡£åŠ è½½å™¨ï¼ˆLoadersï¼‰                   â”‚
â”‚  â€¢ PyPDFLoader                          â”‚
â”‚  â€¢ Docx2txtLoader                       â”‚
â”‚  â€¢ Unstructured (é«˜çº§å¤„ç†)              â”‚
â”‚  â€¢ OCR (pytesseract)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. LangChainRAGService (`langchain_rag_service.py`)

**èŒè´£**: RAGç³»ç»Ÿçš„æ ¸å¿ƒæœåŠ¡ï¼Œåè°ƒæ–‡æ¡£å¤„ç†ã€å‘é‡åŒ–å’Œæ£€ç´¢ç”Ÿæˆ

**å…³é”®ç»„ä»¶**:
```python
class LangChainRAGService:
    def __init__(self):
        self.embeddings = HuggingFaceEmbeddings()  # BGEåµŒå…¥æ¨¡å‹
        self.llm = ChatOpenAI()                    # GPT-3.5-turbo
        self.text_splitter = RecursiveCharacterTextSplitter()  # æ–‡æœ¬åˆ†å‰²
        self.vector_stores = {}                    # FAISSå‘é‡åº“ç¼“å­˜
        self.cache_manager = SmartCacheManager()   # æŸ¥è¯¢ç¼“å­˜
```

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… æ–‡æ¡£åŠ è½½å’Œé¢„å¤„ç†
- âœ… æ™ºèƒ½æ–‡æœ¬åˆ†å‰²ï¼ˆchunk_size=1000, overlap=200ï¼‰
- âœ… å‘é‡åŒ–å’Œå­˜å‚¨ï¼ˆFAISSï¼‰
- âœ… ç›¸ä¼¼æ€§æ£€ç´¢
- âœ… LLMç”Ÿæˆï¼ˆask_questionï¼‰
- âœ… æ··åˆæ£€ç´¢ï¼ˆå·¥ä½œåŒº + å…¨å±€æ•°æ®åº“ï¼‰

### 2. EnhancedDocumentProcessor (`enhanced_document_processor.py`)

**èŒè´£**: é«˜çº§æ–‡æ¡£è§£æï¼Œæ”¯æŒå¤šæ¨¡æ€å†…å®¹æå–

**æ”¯æŒçš„æ ¼å¼**: PDF, DOCX, XLSX, PPTX, TXT, MD

**é«˜çº§ç‰¹æ€§**:
- âœ… ä½¿ç”¨ `unstructured` åº“è¿›è¡Œç»“æ„åŒ–è§£æ
- âœ… æå–è¡¨æ ¼ã€åˆ—è¡¨ã€æ ‡é¢˜ç­‰è¯­ä¹‰å…ƒç´ 
- âœ… OCRï¼ˆå›¾ç‰‡æ–‡å­—è¯†åˆ«ï¼‰
- âœ… è´¨é‡è¯„åˆ†ï¼ˆquality_scoreï¼‰
- âœ… æ™ºèƒ½åˆ†å—ï¼ˆæŒ‰å…ƒç´ ç±»å‹ï¼‰

**å¤„ç†æµç¨‹**:
```python
async def process_document(file_path) -> ProcessedDocument:
    # 1. æ£€æµ‹æ–‡ä»¶ç±»å‹
    file_type = _detect_file_type(file_path)
    
    # 2. ä½¿ç”¨unstructuredè§£æ
    elements = _parse_with_unstructured(file_path)
    
    # 3. æ™ºèƒ½åˆ†å—
    chunks = _smart_chunking(elements)
    
    # 4. è´¨é‡è¯„ä¼°
    quality_score = _calculate_quality_score(chunks)
    
    return ProcessedDocument(chunks, quality_score)
```

### 3. SmartCacheManager (`smart_cache_manager.py`)

**èŒè´£**: æ™ºèƒ½æŸ¥è¯¢ç¼“å­˜ï¼Œå‡å°‘é‡å¤LLMè°ƒç”¨

**ç­–ç•¥**:
- TTLç¼“å­˜ï¼ˆé»˜è®¤1å°æ—¶ï¼‰
- è¯­ä¹‰ç¼“å­˜ï¼ˆç›¸ä¼¼é—®é¢˜å¤ç”¨ç­”æ¡ˆï¼‰
- LRUæ·˜æ±°ç­–ç•¥

### 4. FAISS Vector Store

**èŒè´£**: é«˜æ•ˆå‘é‡ç›¸ä¼¼æ€§æœç´¢

**ç‰¹ç‚¹**:
- âœ… æœ¬åœ°å‘é‡åº“ï¼ˆæ— å¤–éƒ¨ä¾èµ–ï¼‰
- âœ… å¿«é€Ÿè¿‘ä¼¼æœç´¢
- âœ… æ”¯æŒå¢é‡æ·»åŠ 

**å­˜å‚¨ç»“æ„**:
```
langchain_vector_db/
â”œâ”€â”€ workspace_{id}/
â”‚   â”œâ”€â”€ index.faiss      # å‘é‡ç´¢å¼•
â”‚   â””â”€â”€ index.pkl        # å…ƒæ•°æ®
â””â”€â”€ global_db/
    â”œâ”€â”€ index.faiss
    â””â”€â”€ index.pkl
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### æ–‡æ¡£å¤„ç†æµç¨‹

```
1. æ–‡æ¡£ä¸Šä¼ 
   â””â”€> app_simple.py: upload_document_api()
       â”‚
       â”œâ”€> ä¿å­˜æ–‡ä»¶åˆ° /tmp/
       â”‚
       â””â”€> åˆ›å»ºåå°ä»»åŠ¡ (Task Queue)
           â”‚
           â””â”€> process_document_async()
               â”‚
               â”œâ”€> LangChainRAGService.add_document()
               â”‚   â”‚
               â”‚ AGè´Ÿè·åŠ è½½: EnhancedDocumentProcessor
               â”‚   â”‚
               â”‚   â”œâ”€> è§£ææ–‡æ¡£ (unstructured/pypdf/docx2txt)
               â”‚   â”‚
               â”‚   â”œâ”€> æ™ºèƒ½åˆ†å— (RecursiveCharacterTextSplitter)
               â”‚   â”‚   â”‚
               â”‚   â”‚   â””â”€> chunk_size=1000, overlap=200
               â”‚   â”‚
               â”‚   â”œâ”€> å‘é‡åŒ– (BGE embeddings)
               â”‚   â”‚   â”‚
               â”‚   â”‚   â””â”€> ç”Ÿæˆ768ç»´å‘é‡
               â”‚   â”‚
               â”‚   â””â”€> å­˜å‚¨åˆ°FAISS
               â”‚       â”‚
               â”‚       â””â”€> ä¿å­˜åˆ° global_db/ æˆ– workspace_{id}/
               â”‚
               â””â”€> ä¿å­˜å…ƒæ•°æ®åˆ°JSONæ–‡ä»¶
                   â””â”€> documents.json æˆ– workspace_{id}_documents.json
```

### é—®ç­”æµç¨‹

```
1. ç”¨æˆ·æé—®
   â””â”€> app_simple.py: ask_question()
       â”‚
       â”œâ”€> IntentDetectionï¼ˆæ„å›¾è¯†åˆ«ï¼‰
       â”‚
       â”œâ”€> LangChainRAGService.search_and_answer()
       â”‚   â”‚
       â”‚   â”œâ”€> æ£€ç´¢å·¥ä½œåŒºæ–‡æ¡£ (workspace_id)
       â”‚   â”‚   â”‚
       â”‚   â”‚   â””â”€> FAISSå‘é‡æ£€ç´¢ (top_k=5)
       â”‚   â”‚
       â”‚   â”œâ”€> æ£€ç´¢å…¨å±€æ•°æ®åº“ (global)
       â”‚   â”‚   â”‚
       â”‚   â”‚   â””â”€> FAISSå‘é‡æ£€ç´¢ (top_k=5)
       â”‚   â”‚
       â”‚   â”œâ”€> åˆå¹¶æ£€ç´¢ç»“æœ
       â”‚   â”‚   â”‚
       â”‚   â”‚   â””â”€> all_references = workspace + global
       â”‚   â”‚
       â”‚   â”œâ”€> æ„å»ºæç¤ºè¯
       â”‚   â”‚   â”‚
       â”‚   â”‚   â””â”€> prompt_template.format(context, question)
       â”‚   â”‚
       â”‚   â””â”€> LLMç”Ÿæˆç­”æ¡ˆ
       â”‚       â”‚
       â”‚       â””â”€> ChatOpenAI.ainvoke(prompt)
       â”‚
       â””â”€> è¿”å›ç­”æ¡ˆ + å¼•ç”¨ + å…ƒæ•°æ®
```

---

## âš¡ å½“å‰å®ç°çš„æŠ€æœ¯ç‰¹ç‚¹

### âœ… ä¼˜ç‚¹

1. **å¤šæ ¼å¼æ”¯æŒ**
   - è¦†ç›–PDFã€Wordã€Excelã€PPT
   - ä½¿ç”¨ `unstructured` è¿›è¡Œé«˜çº§è§£æ
   - OCRæ”¯æŒï¼ˆå›¾ç‰‡æ–‡å­—è¯†åˆ«ï¼‰

2. **æ™ºèƒ½åˆ†å—**
   - å›ºå®šçª—å£ï¼ˆ1000å­—ç¬¦ï¼‰ä¸é‡å ï¼ˆ200å­—ç¬¦ï¼‰
   - åŸºäºè¯­ä¹‰å…ƒç´ çš„åˆ†å—ç­–ç•¥

3. **åŒæ•°æ®åº“è®¾è®¡**
   - å…¨å±€æ•°æ®åº“ï¼ˆå…±äº«æ–‡æ¡£ï¼‰
   - å·¥ä½œåŒºæ•°æ®åº“ï¼ˆç§äººæ–‡æ¡£ï¼‰
   - æé—®æ—¶åŒæ—¶æ£€ç´¢

4. **æ€§èƒ½ä¼˜åŒ–**
   - æŸ¥è¯¢ç¼“å­˜ï¼ˆå‡å°‘LLMè°ƒç”¨ï¼‰
   - å¼‚æ­¥å¤„ç†ï¼ˆéé˜»å¡ï¼‰
   - FAISSå¿«é€Ÿæ£€ç´¢

5. **å®¹é”™æœºåˆ¶**
   - å¤šå±‚æ¬¡å›é€€ç­–ç•¥
   - LLMå¤±è´¥æ—¶å›é€€åˆ°æ–‡æœ¬åŒ¹é…
   - ä¼˜é›…å¤„ç†ç¼ºå¤±ä¾èµ–

### âš ï¸ å±€é™

1. **æ–‡æœ¬åˆ†å‰²ç­–ç•¥è¾ƒåŸºç¡€**
   - å›ºå®šçª—å£å¯èƒ½åˆ‡æ–­è¯­ä¹‰å•å…ƒ
   - æœªè€ƒè™‘æ–‡æ¡£ç»“æ„ï¼ˆæ®µè½ã€ç« èŠ‚ï¼‰

2. **æ£€ç´¢èƒ½åŠ›è¾ƒå•ä¸€**
   - ä»…å‘é‡ç›¸ä¼¼æ€§æ£€ç´¢
   - æœªå®ç°å…³é”®å­—æ£€ç´¢
   - æœªåšé‡æ’åºï¼ˆrerankingï¼‰

3. **ä¸Šä¸‹æ–‡çª—å£æœ‰é™**
   - å›ºå®šretrieve top_k=5
   - æœªåšæ™ºèƒ½æˆªæ–­
   - æœªè€ƒè™‘é•¿æ–‡æ¡£ä¼˜åŒ–

4. **æç¤ºè¯å·¥ç¨‹è¾ƒç®€å•**
   - å›ºå®šæ¨¡æ¿
   - æœªæ ¹æ®æ–‡æ¡£ç±»å‹è°ƒæ•´
   - ç¼ºå°‘few-shotç¤ºä¾‹

---

## ğŸš€ ä¸å…ˆè¿›æ–¹æ¡ˆçš„å¯¹æ¯”

### å½“å‰æ–¹æ¡ˆ vs. ä¸šç•Œæœ€ä½³å®è·µ

| ç»´åº¦ | å½“å‰å®ç° | ä¸šç•Œæœ€ä½³å®è·µ | å·®è· |
|------|---------|-------------|------|
| **æ£€ç´¢ç­–ç•¥** | å•ä¸€å‘é‡æ£€ç´¢ | æ··åˆæ£€ç´¢ï¼ˆå‘é‡+BM25+é‡æ’åºï¼‰ | âš ï¸ è¾ƒå¤§ |
| **åˆ†å—ç­–ç•¥** | å›ºå®šçª—å£ | è¯­ä¹‰æ„ŸçŸ¥åˆ†å—ï¼ˆæŒ‰æ®µè½/ç« èŠ‚ï¼‰ | âš ï¸ ä¸­ç­‰ |
| **é‡æ’åº** | âŒ æ—  | âœ… äº¤å‰ç¼–ç å™¨é‡æ’åº | âŒ ç¼ºå¤± |
| **ä¸Šä¸‹æ–‡å‹ç¼©** | âŒ æ—  | âœ… é€‰æ‹©æ€§å‹ç¼© | âŒ ç¼ºå¤± |
| **å¤šè·³æ¨ç†** | âŒ æ—  | âœ… CoT / IRCoT | âŒ ç¼ºå¤± |
| **è¯„ä¼°æŒ‡æ ‡** | âŒ æ—  | âœ… ROUGE, BLEU, LLM-as-judge | âŒ ç¼ºå¤± |
| **Reranking** | âŒ æ—  | âœ… CrossEncoder | âŒ ç¼ºå¤± |

### ä¸šç•Œæ ‡æ†å¯¹æ¯”

#### 1. **LangChain + LlamaIndex (2024)**

**ç‰¹ç‚¹**:
- âœ… **æ™ºèƒ½åˆ†å—**: è¯­ä¹‰åˆ†å‰²å™¨ï¼ˆSemantic Splitterï¼‰
- âœ… **æ··åˆæ£€ç´¢**: Vector + BM25 + å…³é”®è¯
- âœ… **é‡æ’åº**: Cohere/OpenAI reranking
- âœ… **ä¸Šä¸‹æ–‡å‹ç¼©**: MapReduce, Refine chains

**ç¤ºä¾‹**:
```python
# LlamaIndex çš„æ··åˆæ£€ç´¢
retriever = HybridRetriever(vector_retriever, bm25_retriever)
reranker = CohereRerank(model="rerank-english-v3.0")
results = retriever.retrieve(query)
reranked_results = reranker.postprocess_nodes(results, query)
```

#### 2. **DSPy (Stanford, 2024)**

**ç‰¹ç‚¹**:
- âœ… **å¯ç»„åˆçš„æ¨¡å—**: æ£€ç´¢ã€ç”Ÿæˆã€è¯„ä¼°
- âœ… **è‡ªåŠ¨ä¼˜åŒ–**: é€šè¿‡å°‘é‡æ ·æœ¬ä¼˜åŒ–æç¤º
- âœ… **å¯é‡å¤æ€§**: æ˜ç¡®çš„pipelineé…ç½®

#### 3. **Self-RAG (Meta, 2024)**

**ç‰¹ç‚¹**:
- âœ… **è‡ªæˆ‘è¯„ä¼°**: LLMè¯„ä¼°æ£€ç´¢å’Œç”Ÿæˆè´¨é‡
- âœ… **è‡ªé€‚åº”æ£€ç´¢**: åŠ¨æ€å†³å®šæ˜¯å¦æ£€ç´¢
- âœ… **Factual Verification**: äº‹å®æ€§éªŒè¯

---

## ğŸ’¡ æ”¹è¿›æ–¹å‘ä¸å»ºè®®

### ä¼˜å…ˆçº§ P0: ç«‹å³æ”¹è¿›

#### 1. **å®ç°æ··åˆæ£€ç´¢ï¼ˆHybrid Retrievalï¼‰**

**å½“å‰é—®é¢˜**: ä»…ä¾èµ–å‘é‡ç›¸ä¼¼æ€§ï¼Œå¯èƒ½é—æ¼ç²¾ç¡®åŒ¹é…

**æ”¹è¿›æ–¹æ¡ˆ**:
```python
from langchain.retrievers import BM25Retriever
from langchain_community.retrievers import HybridRetriever

# 1. æ·»åŠ BM25æ£€ç´¢å™¨
bm25_retriever = BM25Retriever.from_documents(documents)
bm25_retriever.k = 5

# 2. æ··åˆå‘é‡å’ŒBM25
hybrid_retriever = HybridRetriever(
    vector_retriever=vector_store(v=5),
    bm25_retriever=bm25_retriever
)

# 3. åŠ æƒåˆå¹¶ç»“æœ
results = hybrid_retriever.retrieve(query)
```

**é¢„æœŸæ”¶ç›Š**: æ£€ç´¢å‡†ç¡®ç‡ +15%

#### 2. **è¯­ä¹‰æ„ŸçŸ¥åˆ†å—ï¼ˆSemantic Chunkingï¼‰**

**å½“å‰é—®é¢˜**: å›ºå®šçª—å£åˆ‡æ–­è¯­ä¹‰å®Œæ•´æ€§

**æ”¹è¿›æ–¹æ¡ˆ**:
```python
from langchain_experimental.text_splitter import SemanticChunker
from langchain_openai import OpenAIEmbeddings

# è¯­ä¹‰æ„ŸçŸ¥åˆ†å—
text_splitter = SemanticChunker(
    OpenAIEmbeddings(),
    breakpoint_threshold_type="percentile",  # ç™¾åˆ†æ¯”é˜ˆå€¼
    chunk_size=1000
)
chunks = text_splitter.create_documents([document])
```

**é¢„æœŸæ”¶ç›Š**: æ£€ç´¢å¬å›ç‡ +10%

#### 3. **æ·»åŠ é‡æ’åºï¼ˆRerankingï¼‰**

**å½“å‰é—®é¢˜**: æ£€ç´¢ç»“æœæŒ‰ç›¸ä¼¼åº¦æ’åºï¼Œä½†æœªè€ƒè™‘ä¸é—®é¢˜çš„ç›¸å…³æ€§

**æ”¹è¿›æ–¹æ¡ˆ**:
```python
from sentence_transformers import CrossEncoder

# ä½¿ç”¨äº¤å‰ç¼–ç å™¨é‡æ’åº
reranker = CrossEncoder('cross-encoder/ms-marco-MiniLM-L-12-v2')

# æ£€ç´¢top_k=20
initial_results = vector_store.similarity_search(query, k=20)

# é‡æ’åºåˆ°top_k=5
reranked_results = reranker.rank(
    query, 
    [doc.page_content for doc in initial_results]
)[:5]
```

**é¢„æœŸæ”¶ç›Š**: ç­”æ¡ˆå‡†ç¡®ç‡ +20%

### ä¼˜å…ˆçº§ P1: è¿‘æœŸæ”¹è¿›

#### 4. **ä¸Šä¸‹æ–‡å‹ç¼©ï¼ˆContext Compressionï¼‰**

**æ–¹æ¡ˆ**: ä½¿ç”¨ LangChain çš„ ContextualCompressionRetriever

```python
from langchain.retrievers import ContextualCompressionRetriever
from langchain.retrievers.document_compressors import LLMChainExtractor

# æ„å»ºå‹ç¼©å™¨
compressor = LLMChainExtractor(llm=self.llm)

# å‹ç¼©æ£€ç´¢ç»“æœ
compression_retriever = ContextualCompressionRetriever(
    base_compressor=compressor,
    base_retriever=vector_store.as_retriever()
)
```

**é¢„æœŸæ”¶ç›Š**: ä¸Šä¸‹æ–‡ç›¸å…³æ€§ +25%ï¼ŒTokenä½¿ç”¨ -30%

#### 5. **Promptä¼˜åŒ–ï¼ˆFew-Shot + Chain-of-Thoughtï¼‰**

**æ”¹è¿›æ–¹æ¡ˆ**:
```python
# æ·»åŠ ç¤ºä¾‹å’Œæ¨ç†è¿‡ç¨‹
prompt_template = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIåŠ©æ‰‹ï¼Œæ“…é•¿ä»æ–‡æ¡£ä¸­æå–ä¿¡æ¯ã€‚

# ç¤ºä¾‹
é—®é¢˜: è¿™ä¸ªå…¬å¸çš„è¥æ”¶æ˜¯å¤šå°‘ï¼Ÿ
ä¸Šä¸‹æ–‡: å…¬å¸Aåœ¨2023å¹´å®ç°è¥æ”¶1000ä¸‡å…ƒ
æ¨ç†: é—®é¢˜è¯¢é—®è¥æ”¶ï¼Œæ–‡æ¡£æ˜ç¡®æåˆ°"è¥æ”¶1000ä¸‡å…ƒ"
å›ç­”: å…¬å¸Aåœ¨2023å¹´çš„è¥æ”¶æ˜¯1000ä¸‡å…ƒã€‚

# å½“å‰ä»»åŠ¡
é—®é¢˜: {input}
ä¸Šä¸‹æ–‡: {context}
æ¨ç†: [è¯·æ€è€ƒä¸Šä¸‹æ–‡ä¸é—®é¢˜çš„å…³ç³»]
å›ç­”: [åŸºäºä¸Šä¸‹æ–‡æä¾›å‡†ç¡®ç­”æ¡ˆ]
"""
```

#### 6. **è¯„ä¼°ä½“ç³»**

**æ”¹è¿›æ–¹æ¡ˆ**:
```python
from langchain.evaluation import QAEvalChain

# 1. äººå·¥æ ‡æ³¨æµ‹è¯•é›†
test_set = [
    {
        "question": "idea-gpæ˜¯ä»€ä¹ˆï¼Ÿ",
        "ground_truth": "idea-gpæ˜¯ä¸€ä¸ªxxxxç³»ç»Ÿ"
    }
]

# 2. è¯„ä¼°ç­”æ¡ˆè´¨é‡
evaluator = QAEvalChain.from_llm(llm)
evaluation = evaluator.evaluate(
    examples=test_set,
    predictions=rag_results
)

# 3. æŒ‡æ ‡è®¡ç®—
accuracy = sum(e['correctness'] for e in evaluation) / len(evaluation)
```

### ä¼˜å…ˆçº§ P2: é•¿æœŸè§„åˆ’

#### 7. **å¤šè·³æ¨ç†ï¼ˆMulti-hop Reasoningï¼‰**

**åœºæ™¯**: éœ€è¦ç»„åˆå¤šä¸ªæ–‡æ¡£ç‰‡æ®µå›ç­”é—®é¢˜

**æ–¹æ¡ˆ**: å®ç° Iterative Retrieval Chain

```python
from langchain.chains import SequentialChain

# ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆå­é—®é¢˜
sub_questions = llm.generate(["idea-gpçš„æ ¸å¿ƒåŠŸèƒ½æœ‰å“ªäº›ï¼Ÿ"])

# ç¬¬äºŒæ­¥ï¼šå¯¹æ¯ä¸ªå­é—®é¢˜æ£€ç´¢
results = [retriever.retrieve(q) for q in sub_questions]

# ç¬¬ä¸‰æ­¥ï¼šæ±‡æ€»ç­”æ¡ˆ
final_answer = llm.generate(results)
```

#### 8. **Self-RAG æ¶æ„**

**æ–¹æ¡ˆ**: LLMè‡ªæˆ‘è¯„ä¼°å’Œä¼˜åŒ–

```python
# 1. ç”Ÿæˆself-critique
critique = llm.generate("æˆ‘æ˜¯å¦éœ€è¦æ£€ç´¢æ›´å¤šä¿¡æ¯ï¼Ÿ")

# 2. è‡ªé€‚åº”æ£€ç´¢
if critique.indicates("need_more_info"):
    results = retriever.retrieve(query, k=10)
else:
    results = []  # ä½¿ç”¨å¸¸è¯†å›ç­”

# 3. Factual verification
is_factual = verify(answer, retrieved_docs)
```

#### 9. **Query Expansion & Rewriting**

**æ–¹æ¡ˆ**: æ‰©å±•å’Œé‡å†™æŸ¥è¯¢

```python
# 1. æŸ¥è¯¢æ‰©å±•ï¼ˆåŒä¹‰è¯ã€ç›¸å…³è¯ï¼‰
expanded_query = expand_query("idea-gp")  # -> ["idea-gp", "idea gp", "åˆ›æ–°å·¥ä½œå¹³å°"]

# 2. æŸ¥è¯¢é‡å†™ï¼ˆæ›´æ˜ç¡®çš„è¡¨è¾¾ï¼‰
rewritten_query = llm.generate("ç”¨æ›´å…·ä½“çš„æ–¹å¼è¡¨è¾¾: idea-gpæ˜¯ä»€ä¹ˆ")
```

---

## ğŸ“Š é¢„æœŸæ”¹è¿›æ•ˆæœ

| æŒ‡æ ‡ | å½“å‰ | æ”¹è¿›å (P0+P1) | æå‡ |
|------|------|---------------|------|
| æ£€ç´¢å‡†ç¡®ç‡ | ~65% | ~85% | +20% |
| ç­”æ¡ˆå‡†ç¡®ç‡ | ~70% | ~90% | +20% |
| ä¸Šä¸‹æ–‡ç›¸å…³æ€§ | ~60% | ~80% | +20% |
| TokenèŠ‚çœ | 0% | ~30% | +30% |

---

## ğŸ¯ å®æ–½è·¯çº¿å›¾

### Phase 1 (1-2å‘¨)
- âœ… å®ç°æ··åˆæ£€ç´¢ï¼ˆBM25 + Vectorï¼‰
- âœ… æ·»åŠ é‡æ’åºï¼ˆCrossEncoderï¼‰
- âœ… æ”¹è¿›æç¤ºè¯ï¼ˆFew-shotï¼‰

### Phase 2 (2-4å‘¨)
- âœ… è¯­ä¹‰æ„ŸçŸ¥åˆ†å—
- âœ… ä¸Šä¸‹æ–‡å‹ç¼©
- âœ… è¯„ä¼°ä½“ç³»å»ºç«‹

### Phase 3 (1-2æœˆ)
- âœ… å¤šè·³æ¨ç†
- âœ… Query Expansion
- âœ… Self-RAGå®éªŒ

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **LangChainå®˜æ–¹æ–‡æ¡£**: https://docs.langchain.com
2. **LlamaIndex**: https://docs.llamaindex.ai
3. **Self-RAGè®ºæ–‡**: https://arxiv.org/abs/2310.11511
4. **DSPy**: https://github.com/stanfordnlp/dspy
5. **RAG Survey**: https://arxiv.org/abs/2312.10997

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-01-28  
**ä½œè€…**: AI Assistant
